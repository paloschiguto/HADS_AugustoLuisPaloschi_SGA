datasource db {
  provider = "postgresql"
  url = env("DB_URL_CONECT")
}

generator client {
  provider = "prisma-client-js"
}

// Tipos de usuário
model TipoDeUsuario {
  id          Int       @id @default(autoincrement())
  descricao   String
  createdBy   Int
  createdOn   DateTime @default(now())
  modifiedBy  Int?
  modifiedOn  DateTime?

  usuarios    Usuario[]
  permissoes  Permissao[] @relation("TipoPermissoes")
}

// Usuários do sistema
model Usuario {
  id          Int       @id @default(autoincrement())
  nome        String
  email       String    @unique
  senha       String
  ativo       Boolean @default(true)
  tpUsuId     Int
  createdBy   Int
  createdOn   DateTime @default(now())
  modifiedBy  Int?
  modifiedOn  DateTime?

  tipo        TipoDeUsuario @relation(fields: [tpUsuId], references: [id])
  atendimentos Atendimento[]
  pacientes     Paciente[]
  passwordResets PasswordReset[]

  prescricoesCriadas Prescricao[] @relation("PrescricaoAuthor")
  agendaExecutada    ItemAgenda[] @relation("AgendaExecutor")
}

// Pacientes
model Paciente {
  id          Int       @id @default(autoincrement())
  nome        String
  ativo       Boolean @default(true)
  dataNasc    DateTime?
  respId      Int?
  createdBy   Int
  createdOn   DateTime @default(now())
  modifiedBy  Int?
  modifiedOn  DateTime?

  responsavel Usuario? @relation(fields: [respId], references: [id])
  atendimentos Atendimento[]
  prescricoes Prescricao[]
}

// Medicamentos
model Medicamento {
  id          Int       @id @default(autoincrement())
  descricao   String
  dosagem     String
  ativo       Boolean @default(true)
  createdBy   Int
  createdOn   DateTime @default(now())
  modifiedBy  Int?
  modifiedOn  DateTime?

  atendimentos MedicamentosAtend[]
  prescricoes Prescricao[]
}

model Atendimento {
  id             Int             @id @default(autoincrement())
  descricao      String
  diagnostico    String?
  obs            String?
  cidade         String          
  uf             String
  temperatura    Float?
  peso           Float?
  finalizado     Boolean         @default(false)

  createdBy      Int
  modifiedBy     Int?
  createdOn      DateTime        @default(now())
  modifiedOn     DateTime?

  usuario        Usuario         @relation(fields: [createdBy], references: [id])
  paciente       Paciente        @relation(fields: [pacId], references: [id])
  pacId          Int

  medicamentos   MedicamentosAtend[]
  agendamentoGerador ItemAgenda?
}

model MedicamentosAtend {
  id             Int         @id @default(autoincrement())

  atendimentoId  Int
  medicamentoId  Int

  dosagem        String?
  frequencia     String?
  duracao        String?
  observacao     String?

  atendimento Atendimento @relation(fields: [atendimentoId], references: [id], onDelete: Cascade)
  medicamento Medicamento @relation(fields: [medicamentoId], references: [id])
}


model PasswordReset {
  id         Int      @id @default(autoincrement())
  usuId      Int
  codigo     String
  used       Boolean  @default(false)
  created_on DateTime @default(now())

  usuario    Usuario  @relation(fields: [usuId], references: [id], onDelete: Cascade)
}

// Permissões
model Permissao {
  id          Int       @id @default(autoincrement())
  nome        String    @unique
  tipos       TipoDeUsuario[] @relation("TipoPermissoes")
}


// Nova Tabela: A "Ordem Médica"
// Define a regra: "Tomar X remédio de 8 em 8 horas"
model Prescricao {
  id             Int       @id @default(autoincrement())
  
  pacienteId     Int
  medicamentoId  Int
  
  dosagem        String    // Ex: "5ml", "1 comprimido"
  frequenciaHoras Int      // Ex: 8 (para 8 em 8 horas), 24 (1x ao dia)
  dataInicio     DateTime
  dataFim        DateTime? // Se nulo, é uso contínuo
  ativo          Boolean   @default(true)

  // Auditoria (Seu Padrão)
  createdBy      Int
  createdOn      DateTime  @default(now())
  modifiedBy     Int?
  modifiedOn     DateTime?

  // Relacionamentos
  paciente       Paciente    @relation(fields: [pacienteId], references: [id])
  medicamento    Medicamento @relation(fields: [medicamentoId], references: [id])
  usuarioCriador Usuario     @relation("PrescricaoAuthor", fields: [createdBy], references: [id])
  
  itensAgenda    ItemAgenda[]
}

// Nova Tabela: O "Compromisso na Agenda"
// Cada linha aqui é uma bolinha/card que vai aparecer na tela do cuidador
model ItemAgenda {
  id Int       @id @default(autoincrement())
  prescricaoId Int
  
  dataHoraPrevista DateTime 
  
  status String @default("PENDENTE") 
  
  // Quando for realizado:
  dataHoraRealizada DateTime?
  realizadoPor      Int?

  // Relacionamentos
  prescricao        Prescricao @relation(fields: [prescricaoId], references: [id], onDelete: Cascade)
  usuarioExecutor   Usuario?   @relation("AgendaExecutor", fields: [realizadoPor], references: [id])

  atendimentoId Int? @unique
  atendimento Atendimento? @relation(fields: [atendimentoId], references: [id])
}